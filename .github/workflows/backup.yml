name: Daily Backup

on:
  schedule:
    - cron: "0 2 * * *" # 2 AM UTC daily
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Database Backup
        env:
          BACKUP_URL: ${{ secrets.SUPABASE_BACKUP_URL }}
          BACKUP_TOKEN: ${{ secrets.BACKUP_SECRET_TOKEN }}
        run: |
          if [ -z "$BACKUP_URL" ] || [ -z "$BACKUP_TOKEN" ]; then
            echo "Warning: Backup secrets not configured. Skipping backup."
            exit 0
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $BACKUP_TOKEN" \
            -H "Content-Type: application/json" \
            "$BACKUP_URL")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ]; then
            echo "Backup completed successfully"
            echo "$body"
          else
            echo "Backup failed with HTTP $http_code"
            echo "$body"
            exit 1
          fi
